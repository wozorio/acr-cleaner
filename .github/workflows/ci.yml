name: CI

on:
  pull_request:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  changed-dirs:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.changed-files-base-sha-pull-request.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@v4

      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v5

      - uses: nrwl/nx-set-shas@v3
        id: last_successful_commit_pull_request
        with:
          main-branch-name: ${{ steps.branch-name.outputs.base_ref_branch }} # Get the last successful commit on the master or main branch

      - name: Run changed-files with the commit of the last successful test workflow run on the main branch
        id: changed-files-base-sha-pull-request
        uses: tj-actions/changed-files@v44
        with:
          dir_names: true
          base_sha: ${{ steps.last_successful_commit_pull_request.outputs.base }}
          matrix: true

  lint:
    runs-on: ubuntu-latest

    needs: changed-dirs
    strategy:
      fail-fast: false
      matrix:
        dirs: ${{fromJson(needs.changed-dirs.outputs.dirs)}}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5.1.1
        with:
          python-version: "3.10"

      - name: Setup Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: false
          virtualenvs-path: ${{ matrix.dirs }}

      - name: Install dependencies and Run pylint
        run: |
          poetry install --no-interaction --no-root
          poetry run pylint *.py
        working-directory: ${{ matrix.dirs}}
